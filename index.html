<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>

    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBSQMBZGgCVYCCu0Sdsy40enU7LNRScytw">
    </script>

    <script type="text/javascript">

      var eventMap = {
        'CommitCommentEvent': function(event) { return event['payload']['comment']['html_url']; },
        'CreateEvent': function(event) { return event['repo']['url'].replace("api.", "").replace('/repos', ''); },
        'DeleteEvent': function(event) { return event['repo']['url'].replace("api.", "").replace('/repos', ''); },
        'DeploymentEvent': function(event) { return event['payload']['foo']['bar']; },
        'DeploymentStatusEvent': function(event) { return event['payload']['foo']['bar']; },
        'DownloadEvent': function(event) { return event['payload']['foo']['bar']; },
        'FollowEvent': function(event) { return event['payload']['foo']['bar']; },
        'ForkEvent': function(event) { return event['payload']['forkee']['html_url']; },
        'ForkApplyEvent': function(event) { return event['payload']['foo']['bar']; },
        'GistEvent': function(event) { return event['payload']['foo']['bar']; },
        'GollumEvent': function(event) { return event['payload']['pages'][0]['html_url']; },
        'IssueCommentEvent': function(event) { return event['payload']['comment']['html_url']; },
        'IssuesEvent': function(event) { return event['payload']['issue']['html_url']; },
        'MemberEvent': function(event) { return event['repo']['url'] + '/collaborators'; },
        'PageBuildEvent': function(event) { return event['payload']['foo']['bar']; },
        'PublicEvent': function(event) { return event['repo']['url'].replace("api.", "").replace('/repos', ''); },
        'PullRequestEvent': function(event) { return event['payload']['pull_request']['html_url']; },
        'PullRequestReviewCommentEvent': function(event) { return event['payload']['comment']['html_url']; },
        'PushEvent': function(event) { return 'https://github.com/'+ event['repo']['name'] + '/commit/' + event['payload']['head']; },
        'ReleaseEvent': function(event) { return event['payload']['release']['html_url']; },
        'StatusEvent': function(event) { return event['payload']['foo']['bar']; },
        'TeamAddEvent': function(event) { return event['repo']['url']['bar']; },
        'WatchEvent': function(event) { return 'https://github.com/' + event['repo']['name'] + '/watchers'; },
      };

      var map;
      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(30, 0),
          zoom: 2
        };
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
      }
      google.maps.event.addDomListener(window, 'load', initialize);

      var host = location.origin.replace(/^http/, 'ws')
      var ws = new WebSocket(host);
      ws.onmessage = function (message) {
        processEvent(JSON.parse(message.data));
      };

      function processEvent(data) {
        var marker = new google.maps.Marker({
          map: map,
          animation: google.maps.Animation.DROP,
          position: new google.maps.LatLng(data.geo.lat, data.geo.lng),
          icon: image = {
            url: data.user.avatar_url,
            size: new google.maps.Size(24, 24),
            origin: new google.maps.Point(0, 0),
            anchor: new google.maps.Point(0, 0),
            scaledSize: new google.maps.Size(24, 24)
          }
        });

        var infowindow = new google.maps.InfoWindow({
          content:
            '<a target="_blank" href="' + data.user.html_url + '">' +
              '<img src="' + data.user.avatar_url + '" height="48" width="48" alt="' + data.user.login + '" title="' + data.user.login + '">' +
            '</a>' +
            '<a target="_blank" href="' + data.user.html_url + '">' + data.user.login + '</a>' +
            data.user.location +
            '<a target="_blank" href="https://github.com/' + data.event.repo.name + '">' + data.event.repo.name + '</a>' +
            '<a target="_blank" href="' + eventMap[data.event.type](data.event) + '">' + data.event.type + '</a>'

            // 'type: ' + data.event.type + '<br>' +
            // 'payload: ' + payload + '<br>' +
            // JSON.stringify(data.event)
        });
        google.maps.event.addListener(marker, 'click', function() {
          infowindow.open(map, marker);
        });
      }
    </script>
  </head>
  <body>
    <div id="map-canvas"/>
  </body>
</html>