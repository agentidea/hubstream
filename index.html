<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>

    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBSQMBZGgCVYCCu0Sdsy40enU7LNRScytw">
    </script>

    <script type="text/javascript">

      var eventMap = {
        'CommitCommentEvent': ['comment', 'html_url'],
        'CreateEvent': ['repo', 'url'],
        'DeleteEvent': ['repo', 'url'],
        'DeploymentEvent': [],
        'DeploymentStatusEvent': [],
        'DownloadEvent': ['download'],
        'FollowEvent': ['target', 'login'],
        'ForkEvent': ['forkee', 'full_name'],
        'ForkApplyEvent': ['head'],
        'GistEvent': ['action'],
        'GollumEvent': ['pages', 'html_url'],
        'IssueCommentEvent': ['comment', 'html_url'],
        'IssuesEvent': ['issue', 'html_url'],
        'MemberEvent': ['member', 'html_url'],
        'PageBuildEvent': ['build', 'url'],
        'PublicEvent': ['repo', 'html_url'],
        'PullRequestEvent': ['pull_request', 'html_url'],
        'PullRequestReviewCommentEvent': ['comment', 'html_url'],
        'PushEvent': ['compare'],
        'ReleaseEvent': ['release', 'html_url'],
        'StatusEvent': ['repo', 'html_url'],
        'TeamAddEvent': ['user', 'login'],
        'WatchEvent': ['repo', 'html_url']
      };

      var map;
      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(30, 0),
          zoom: 2
        };
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
      }
      google.maps.event.addDomListener(window, 'load', initialize);

      var host = location.origin.replace(/^http/, 'ws')
      var ws = new WebSocket(host);
      ws.onmessage = function (message) {
        processEvent(JSON.parse(message.data));
      };

      function processEvent(data) {
        var marker = new google.maps.Marker({
          map: map,
          animation: google.maps.Animation.DROP,
          position: new google.maps.LatLng(data.geo.lat, data.geo.lng),
          icon: image = {
            url: data.user.avatar_url,
            size: new google.maps.Size(24, 24),
            origin: new google.maps.Point(0, 0),
            anchor: new google.maps.Point(0, 0),
            scaledSize: new google.maps.Size(24, 24)
          }
        });

        var fields = eventMap[data.event.type]
        var payload = data.event['payload'][fields[0]];
        if (fields.length > 1) {
          payload = payload[fields[1]];
        }

        var infowindow = new google.maps.InfoWindow({
          content:
            '<a target="_blank" href="' + data.user.html_url + '">' +
              '<img src="' + data.user.avatar_url + '" height="48" width="48" alt="' + data.user.login + '" title="' + data.user.login + '">' +
            '</a>' +
            '<a target="_blank" href="' + data.user.html_url + '">' + data.user.login + '</a>' +
            data.user.location +
            '<a target="_blank" href="https://github.com/' + data.event.repo.name + '">' + data.event.repo.name + '</a>' +
            'type: ' + data.event.type + '<br>' +
            'payload: ' + payload + '<br>' +
            JSON.stringify(data.event)
        });
        google.maps.event.addListener(marker, 'click', function() {
          infowindow.open(map, marker);
        });
      }
    </script>
  </head>
  <body>
    <div id="map-canvas"/>
  </body>
</html>